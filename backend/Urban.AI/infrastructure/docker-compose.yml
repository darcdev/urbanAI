name: ${PROJECT_NAME}

services:

  # ASP.NET Core Web API
  web-api:
    image: ${PROJECT_NAME}.webapi
    container_name: webapi
    build:
      context: ..
      dockerfile: src/Urban.AI.WebApi/Dockerfile
    depends_on:
      db-postgresql:
        condition: service_healthy
      minio-storage:
        condition: service_healthy
    ports:
      - ${API_HTTP_PORT}:8080
      - ${API_HTTPS_PORT}:8081
    environment:
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT}
      - ASPNETCORE_HTTPS_PORT=${API_HTTPS_PORT}
      - ConnectionStrings__DefaultConnectionDb=Host=db-postgresql;Port=5432;Database=${PROJECT_NAME};Username=postgres;Password=postgres;
      - Minio__Host=minio-storage:9000
      - Minio__Username=rootadmin
      - Minio__Password=rootadmin
      - Minio__IsSecureSSL=false
      - Authentication__Audience=account
      - Authentication__ValidIssuer=http://identity-keycloak:8080/realms/${PROJECT_NAME}
      - Authentication__MetadataUrl=http://identity-keycloak:8080/realms/${PROJECT_NAME}/.well-known/openid-configuration
      - Authentication__RequireHttpsMetadata=false
      - Keycloak__BaseUrl=http://identity-keycloak:8080
      - Keycloak__AdminUrl=http://identity-keycloak:8080/admin/realms/${PROJECT_NAME}/
      - Keycloak__TokenUrl=http://identity-keycloak:8080/realms/${PROJECT_NAME}/protocol/openid-connect/token
    restart: on-failure
    networks:
      - network-public
     
  # SQL Server database
  db-sqlserver:
    image: mcr.microsoft.com/mssql/server:2019-latest
    container_name: sqlserver.db
    restart: on-failure
    profiles:
      - sqlserver
    env_file:
      - sqlserver.env
    ports:
      - '${MSSQL_PORT_HOST:-1433}:1433'
    volumes:
      - sqlserver-data:/var/opt/mssql
    networks:
      - network-public
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -c '</dev/tcp/127.0.0.1/1433' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 20s

  # PostgreSQL database
  db-postgresql:
    image: postgres:17
    container_name: postgres.db
    restart: on-failure
    env_file:
      - postgres.env
    environment:
      POSTGRES_DB: ${PROJECT_NAME}
    volumes:
      - vol_postgres_db:/var/lib/postgresql/data
    ports:
      - '${PG_PORT_HOST:-5432}:5432'
    networks:
      - network-public
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "postgres"]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s

  # MongoDB
  db-mongo:
    image: mongo:latest
    container_name: mongo.db
    restart: on-failure
    profiles:
      - mongo
    env_file:
      - mongo.env
    ports:
      - '${MONGO_PORT_HOST:-27017}:27017'
    volumes:
      - vol_mongo:/data/db
    networks:
      - network-public
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -c '</dev/tcp/127.0.0.1/27017' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 10s

  # MinIO object storage
  minio-storage:
    image: minio/minio:latest
    container_name: minio.storage
    restart: on-failure
    env_file:
      - minio.env
    volumes:
      - vol_minio_storage:/data
    ports:
      - '${MINIO_API_HOST_PORT:-9000}:9000'
      - '${MINIO_CONSOLE_HOST_PORT:-9001}:9001'
    networks:
      - network-public
    command: server --console-address ":9001" /data
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -c '</dev/tcp/127.0.0.1/9000' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 10s

  identity-keycloak:
    image: quay.io/keycloak/keycloak:${KEYCLOAK_VERSION}
    container_name: keycloak.identity
    restart: on-failure
    command: start-dev --import-realm --health-enabled=true --http-enabled=true --hostname-strict=false --hostname-strict-https=false
    env_file:
      - keycloak.env
    environment:
      - KC_HEALTH_ENABLED=true
      - KC_METRICS_ENABLED=true
      - KC_HTTP_ENABLED=true
      - KC_HOSTNAME_STRICT=false
      - KC_HOSTNAME_STRICT_HTTPS=false
      - KC_PROXY_HEADERS=xforwarded
    volumes:
      - vol_keycloak_data:/opt/keycloak/data
      - ./resources/application-realm-export.json:/opt/keycloak/data/import/realm.json
    ports:
      - '${KEYCLOAK_HTTP_PORT:-18080}:8080'
    networks:
      - network-public
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/127.0.0.1/8080;echo -e 'GET /health/ready HTTP/1.1\r\nhost: 127.0.0.1:8080\r\nConnection: close\r\n\r\n' >&3;cat <&3 | grep -q '200 OK'"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 30s
      
networks:
  network-public:
    name: ${PROJECT_NAME}-network-public
    driver: bridge

volumes:
  sqlserver-data:
    driver: local
  vol_minio_storage: {}
  vol_postgres_db: {}
  vol_mongo: {}
  vol_keycloak_data: {}
