name: ${PROJECT_NAME}

services:

  # ASP.NET Core Web API
  web-api:
    image: ${PROJECT_NAME}.webapi:latest
    container_name: urbanai-webapi
    build:
      context: ..
      dockerfile: src/Urban.AI.WebApi/Dockerfile
    depends_on:
      db-postgresql:
        condition: service_healthy
      minio-storage:
        condition: service_healthy
      identity-keycloak:
        condition: service_healthy
    ports:
      - "${API_HTTP_PORT:-5152}:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
    restart: unless-stopped
    networks:
      - urbanai-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # PostgreSQL database
  db-postgresql:
    image: postgres:17-alpine
    container_name: urbanai-postgres
    restart: unless-stopped
    env_file:
      - postgres.env
    environment:
      POSTGRES_DB: ${PROJECT_NAME}
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./resources/data_departments.sql:/docker-entrypoint-initdb.d/01_departments.sql
      - ./resources/data_municipalities.sql:/docker-entrypoint-initdb.d/02_municipalities.sql
      - ./resources/data_rural_districts.sql:/docker-entrypoint-initdb.d/03_rural_districts.sql
    ports:
      - "${PG_PORT_HOST:-5432}:5432"
    networks:
      - urbanai-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # MinIO object storage
  minio-storage:
    image: minio/minio:latest
    container_name: urbanai-minio
    restart: unless-stopped
    env_file:
      - minio.env
    volumes:
      - minio-data:/data
    ports:
      - "${MINIO_API_HOST_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_HOST_PORT:-9001}:9001"
    networks:
      - urbanai-network
    command: server --console-address ":9001" /data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Keycloak Identity
  identity-keycloak:
    image: quay.io/keycloak/keycloak:${KEYCLOAK_VERSION}
    container_name: urbanai-keycloak
    restart: unless-stopped
    command: start --import-realm --health-enabled=true
    env_file:
      - keycloak.env
    environment:
      - KC_HEALTH_ENABLED=true
      - KC_METRICS_ENABLED=true
      - KC_HTTP_ENABLED=true
      - KC_HOSTNAME_STRICT=false
    volumes:
      - keycloak-data:/opt/keycloak/data
      - ./resources/application-realm-export.json:/opt/keycloak/data/import/realm.json
    ports:
      - "${KEYCLOAK_HTTP_PORT:-18080}:8080"
    networks:
      - urbanai-network
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/127.0.0.1/8080;echo -e 'GET /health/ready HTTP/1.1\r\nhost: 127.0.0.1\r\nConnection: close\r\n\r\n' >&3;if [ $? -eq 0 ]; then echo 'Healthcheck Successful';exit 0;else echo 'Healthcheck Failed';exit 1;fi;"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 60s

networks:
  urbanai-network:
    name: ${PROJECT_NAME}-network
    driver: bridge

volumes:
  postgres-data:
    driver: local
  minio-data:
    driver: local
  keycloak-data:
    driver: local
